{"version":3,"names":["_getJestObj","mock","async","getItem","jest","fn","setItem","removeItem","encryption","encrypt","decrypt","handleError","_interopRequireDefault","require","default","_asyncToGenerator2","_errors","_security","_storage","_queue","_require","describe","beforeEach","clearAllMocks","asyncStorage","mockResolvedValue","it","expect","getQueue","resolves","toEqual","JSON","stringify","id","url","queue","toHaveBeenCalledWith","mockRejectedValue","Error","toHaveBeenCalled","legacy","spyOn","Date","mockReturnValue","ok","addToQueue","method","toBe","timestamp","now","mockRestore","not","removeFromQueue","clearQueue"],"sources":["queue.test.js"],"sourcesContent":["/**\r\n * Offline Queue Tests\r\n * File: queue.test.js\r\n */\r\nimport { handleError } from '@errors';\r\nimport { encryption } from '@security';\r\nimport { async as asyncStorage } from '@services/storage';\r\nimport { addToQueue, clearQueue, getQueue, removeFromQueue } from '@offline/queue';\r\n\r\njest.mock('@services/storage', () => ({\r\n  async: {\r\n    getItem: jest.fn(),\r\n    setItem: jest.fn(),\r\n    removeItem: jest.fn(),\r\n  },\r\n}));\r\n\r\njest.mock('@security', () => ({\r\n  encryption: {\r\n    encrypt: jest.fn(),\r\n    decrypt: jest.fn(),\r\n  },\r\n}));\r\n\r\njest.mock('@errors', () => ({\r\n  handleError: jest.fn(),\r\n}));\r\n\r\ndescribe('Offline Queue', () => {\r\n  beforeEach(() => {\r\n    jest.clearAllMocks();\r\n    asyncStorage.getItem.mockResolvedValue(null);\r\n    asyncStorage.setItem.mockResolvedValue(true);\r\n    asyncStorage.removeItem.mockResolvedValue(true);\r\n\r\n    encryption.encrypt.mockResolvedValue('encrypted');\r\n    encryption.decrypt.mockResolvedValue('[]');\r\n  });\r\n\r\n  describe('getQueue', () => {\r\n    it('returns [] when nothing is stored', async () => {\r\n      asyncStorage.getItem.mockResolvedValue(null);\r\n      await expect(getQueue()).resolves.toEqual([]);\r\n    });\r\n\r\n    it('decrypts stored string and returns parsed array', async () => {\r\n      asyncStorage.getItem.mockResolvedValue('ciphertext');\r\n      encryption.decrypt.mockResolvedValue(JSON.stringify([{ id: '1', url: '/x' }]));\r\n\r\n      const queue = await getQueue();\r\n\r\n      expect(encryption.decrypt).toHaveBeenCalledWith('ciphertext');\r\n      expect(queue).toEqual([{ id: '1', url: '/x' }]);\r\n    });\r\n\r\n    it('returns [] and clears storage when decryption fails', async () => {\r\n      asyncStorage.getItem.mockResolvedValue('ciphertext');\r\n      encryption.decrypt.mockRejectedValue(new Error('ENCRYPTION_NOT_IMPLEMENTED'));\r\n\r\n      const queue = await getQueue();\r\n\r\n      expect(queue).toEqual([]);\r\n      expect(handleError).toHaveBeenCalled();\r\n      expect(asyncStorage.removeItem).toHaveBeenCalledWith('offline_queue');\r\n    });\r\n\r\n    it('returns [] and clears storage on corrupted decrypted JSON', async () => {\r\n      asyncStorage.getItem.mockResolvedValue('ciphertext');\r\n      encryption.decrypt.mockResolvedValue('not-json');\r\n\r\n      const queue = await getQueue();\r\n\r\n      expect(queue).toEqual([]);\r\n      expect(handleError).toHaveBeenCalled();\r\n      expect(asyncStorage.removeItem).toHaveBeenCalledWith('offline_queue');\r\n    });\r\n\r\n    it('migrates legacy unencrypted array by encrypting and re-saving', async () => {\r\n      const legacy = [{ id: '1', url: '/legacy' }];\r\n      asyncStorage.getItem.mockResolvedValue(legacy);\r\n      encryption.encrypt.mockResolvedValue('encrypted-legacy');\r\n\r\n      const queue = await getQueue();\r\n\r\n      expect(queue).toEqual(legacy);\r\n      expect(encryption.encrypt).toHaveBeenCalledWith(JSON.stringify(legacy));\r\n      expect(asyncStorage.setItem).toHaveBeenCalledWith('offline_queue', 'encrypted-legacy');\r\n    });\r\n\r\n    it('clears legacy unencrypted array if encryption is unavailable', async () => {\r\n      const legacy = [{ id: '1', url: '/legacy' }];\r\n      asyncStorage.getItem.mockResolvedValue(legacy);\r\n      encryption.encrypt.mockRejectedValue(new Error('ENCRYPTION_NOT_IMPLEMENTED'));\r\n\r\n      const queue = await getQueue();\r\n\r\n      expect(queue).toEqual([]);\r\n      expect(asyncStorage.removeItem).toHaveBeenCalledWith('offline_queue');\r\n    });\r\n  });\r\n\r\n  describe('addToQueue', () => {\r\n    it('adds request with id/timestamp and persists encrypted', async () => {\r\n      jest.spyOn(Date, 'now').mockReturnValue(12345);\r\n      asyncStorage.getItem.mockResolvedValue(null);\r\n      encryption.decrypt.mockResolvedValue('[]');\r\n      encryption.encrypt.mockResolvedValue('encrypted-new');\r\n\r\n      const ok = await addToQueue({ url: '/api/test', method: 'POST' });\r\n\r\n      expect(ok).toBe(true);\r\n      expect(encryption.encrypt).toHaveBeenCalledWith(\r\n        JSON.stringify([{ url: '/api/test', method: 'POST', id: '12345', timestamp: 12345 }])\r\n      );\r\n      expect(asyncStorage.setItem).toHaveBeenCalledWith('offline_queue', 'encrypted-new');\r\n\r\n      Date.now.mockRestore();\r\n    });\r\n\r\n    it('fails safely (returns false) when encryption fails and does not persist plaintext', async () => {\r\n      asyncStorage.getItem.mockResolvedValue(null);\r\n      encryption.decrypt.mockResolvedValue('[]');\r\n      encryption.encrypt.mockRejectedValue(new Error('ENCRYPTION_NOT_IMPLEMENTED'));\r\n\r\n      const ok = await addToQueue({ url: '/api/test', method: 'POST' });\r\n\r\n      expect(ok).toBe(false);\r\n      expect(asyncStorage.setItem).not.toHaveBeenCalled();\r\n      expect(handleError).toHaveBeenCalled();\r\n    });\r\n  });\r\n\r\n  describe('removeFromQueue', () => {\r\n    it('removes item by id and persists encrypted', async () => {\r\n      asyncStorage.getItem.mockResolvedValue('ciphertext');\r\n      encryption.decrypt.mockResolvedValue(\r\n        JSON.stringify([\r\n          { id: '1', url: '/a' },\r\n          { id: '2', url: '/b' },\r\n        ])\r\n      );\r\n      encryption.encrypt.mockResolvedValue('encrypted-filtered');\r\n\r\n      const ok = await removeFromQueue('2');\r\n\r\n      expect(ok).toBe(true);\r\n      expect(encryption.encrypt).toHaveBeenCalledWith(JSON.stringify([{ id: '1', url: '/a' }]));\r\n      expect(asyncStorage.setItem).toHaveBeenCalledWith('offline_queue', 'encrypted-filtered');\r\n    });\r\n  });\r\n\r\n  describe('clearQueue', () => {\r\n    it('removes the queue key', async () => {\r\n      const ok = await clearQueue();\r\n      expect(ok).toBe(true);\r\n      expect(asyncStorage.removeItem).toHaveBeenCalledWith('offline_queue');\r\n    });\r\n  });\r\n});\r\n\r\n"],"mappings":"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","ignoreList":[]}