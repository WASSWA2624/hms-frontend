60facbe51cde385253779e632ae5f79b
var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault").default;
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.stopSync = exports.startSync = exports.processQueue = exports.default = exports.__unsafeResetForTests = void 0;
var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));
var _errors = require("../errors");
var _api = require("../services/api");
var _queue = require("./queue");
var _network = require("./network.listener");
var unsubscribeSync = null;
var processQueue = exports.processQueue = function () {
  var _ref = (0, _asyncToGenerator2.default)(function* () {
    if (!(0, _network.getIsOnline)()) return;
    var queue = yield (0, _queue.getQueue)();
    if (queue.length === 0) return;
    for (var item of queue) {
      try {
        yield (0, _api.apiClient)(item);
        yield (0, _queue.removeFromQueue)(item.id);
      } catch (error) {
        (0, _errors.handleError)(error, {
          scope: 'offline.sync.manager',
          op: 'processQueueItem',
          id: item == null ? void 0 : item.id
        });
      }
    }
  });
  return function processQueue() {
    return _ref.apply(this, arguments);
  };
}();
var startSync = exports.startSync = function startSync() {
  if (unsubscribeSync) return unsubscribeSync;
  unsubscribeSync = (0, _network.subscribe)(function (isOnline) {
    if (isOnline) {
      processQueue();
    }
  });
  return unsubscribeSync;
};
var stopSync = exports.stopSync = function stopSync() {
  if (!unsubscribeSync) return;
  try {
    unsubscribeSync();
  } finally {
    unsubscribeSync = null;
  }
};
var __unsafeResetForTests = exports.__unsafeResetForTests = function __unsafeResetForTests() {
  stopSync();
};
var _default = exports.default = {
  processQueue: processQueue,
  startSync: startSync,
  stopSync: stopSync
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfZXJyb3JzIiwicmVxdWlyZSIsIl9hcGkiLCJfcXVldWUiLCJfbmV0d29yayIsInVuc3Vic2NyaWJlU3luYyIsInByb2Nlc3NRdWV1ZSIsImV4cG9ydHMiLCJfcmVmIiwiX2FzeW5jVG9HZW5lcmF0b3IyIiwiZGVmYXVsdCIsImdldElzT25saW5lIiwicXVldWUiLCJnZXRRdWV1ZSIsImxlbmd0aCIsIml0ZW0iLCJhcGlDbGllbnQiLCJyZW1vdmVGcm9tUXVldWUiLCJpZCIsImVycm9yIiwiaGFuZGxlRXJyb3IiLCJzY29wZSIsIm9wIiwiYXBwbHkiLCJhcmd1bWVudHMiLCJzdGFydFN5bmMiLCJzdWJzY3JpYmUiLCJpc09ubGluZSIsInN0b3BTeW5jIiwiX191bnNhZmVSZXNldEZvclRlc3RzIiwiX2RlZmF1bHQiXSwic291cmNlcyI6WyJzeW5jLm1hbmFnZXIuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIFN5bmMgTWFuYWdlclxyXG4gKiBPcmNoZXN0cmF0ZXMgcXVldWUgZXhlY3V0aW9uXHJcbiAqIEZpbGU6IHN5bmMubWFuYWdlci5qc1xyXG4gKi9cclxuaW1wb3J0IHsgaGFuZGxlRXJyb3IgfSBmcm9tICdAZXJyb3JzJztcclxuaW1wb3J0IHsgYXBpQ2xpZW50IH0gZnJvbSAnQHNlcnZpY2VzL2FwaSc7XHJcbmltcG9ydCB7IGdldFF1ZXVlLCByZW1vdmVGcm9tUXVldWUgfSBmcm9tICdAb2ZmbGluZS9xdWV1ZSc7XHJcbmltcG9ydCB7IGdldElzT25saW5lLCBzdWJzY3JpYmUgfSBmcm9tICdAb2ZmbGluZS9uZXR3b3JrLmxpc3RlbmVyJztcclxuXHJcbmxldCB1bnN1YnNjcmliZVN5bmMgPSBudWxsO1xyXG5cclxuZXhwb3J0IGNvbnN0IHByb2Nlc3NRdWV1ZSA9IGFzeW5jICgpID0+IHtcclxuICBpZiAoIWdldElzT25saW5lKCkpIHJldHVybjtcclxuXHJcbiAgY29uc3QgcXVldWUgPSBhd2FpdCBnZXRRdWV1ZSgpO1xyXG4gIGlmIChxdWV1ZS5sZW5ndGggPT09IDApIHJldHVybjtcclxuXHJcbiAgZm9yIChjb25zdCBpdGVtIG9mIHF1ZXVlKSB7XHJcbiAgICB0cnkge1xyXG4gICAgICBhd2FpdCBhcGlDbGllbnQoaXRlbSk7XHJcbiAgICAgIGF3YWl0IHJlbW92ZUZyb21RdWV1ZShpdGVtLmlkKTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGhhbmRsZUVycm9yKGVycm9yLCB7XHJcbiAgICAgICAgc2NvcGU6ICdvZmZsaW5lLnN5bmMubWFuYWdlcicsXHJcbiAgICAgICAgb3A6ICdwcm9jZXNzUXVldWVJdGVtJyxcclxuICAgICAgICBpZDogaXRlbT8uaWQsXHJcbiAgICAgIH0pO1xyXG4gICAgICAvLyBLZWVwIGluIHF1ZXVlIGZvciByZXRyeVxyXG4gICAgfVxyXG4gIH1cclxufTtcclxuXHJcbi8qKlxyXG4gKiBTdGFydCBzeW5jaW5nIG9uIG5ldHdvcmsgcmVjb25uZWN0LlxyXG4gKiBJZGVtcG90ZW50OiByZXBlYXRlZCBjYWxscyByZXR1cm4gdGhlIHNhbWUgdW5zdWJzY3JpYmUgZnVuY3Rpb24uXHJcbiAqL1xyXG5leHBvcnQgY29uc3Qgc3RhcnRTeW5jID0gKCkgPT4ge1xyXG4gIGlmICh1bnN1YnNjcmliZVN5bmMpIHJldHVybiB1bnN1YnNjcmliZVN5bmM7XHJcblxyXG4gIHVuc3Vic2NyaWJlU3luYyA9IHN1YnNjcmliZSgoaXNPbmxpbmUpID0+IHtcclxuICAgIGlmIChpc09ubGluZSkge1xyXG4gICAgICAvLyBGaXJlLWFuZC1mb3JnZXQ7IG9mZmxpbmUgc3luYyBtdXN0IG5vdCBibG9jayBVSSB0aHJlYWQuXHJcbiAgICAgIHByb2Nlc3NRdWV1ZSgpO1xyXG4gICAgfVxyXG4gIH0pO1xyXG5cclxuICByZXR1cm4gdW5zdWJzY3JpYmVTeW5jO1xyXG59O1xyXG5cclxuZXhwb3J0IGNvbnN0IHN0b3BTeW5jID0gKCkgPT4ge1xyXG4gIGlmICghdW5zdWJzY3JpYmVTeW5jKSByZXR1cm47XHJcbiAgdHJ5IHtcclxuICAgIHVuc3Vic2NyaWJlU3luYygpO1xyXG4gIH0gZmluYWxseSB7XHJcbiAgICB1bnN1YnNjcmliZVN5bmMgPSBudWxsO1xyXG4gIH1cclxufTtcclxuXHJcbi8qKlxyXG4gKiBUZXN0aW5nLW9ubHkgcmVzZXQgaGVscGVyIHRvIGF2b2lkIHN0YXRlIGxlYWtpbmcgYWNyb3NzIHVuaXQgdGVzdHMuXHJcbiAqIEBwcml2YXRlXHJcbiAqL1xyXG5leHBvcnQgY29uc3QgX191bnNhZmVSZXNldEZvclRlc3RzID0gKCkgPT4ge1xyXG4gIHN0b3BTeW5jKCk7XHJcbn07XHJcblxyXG5leHBvcnQgZGVmYXVsdCB7XHJcbiAgcHJvY2Vzc1F1ZXVlLFxyXG4gIHN0YXJ0U3luYyxcclxuICBzdG9wU3luYyxcclxufTtcclxuXHJcbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBS0EsSUFBQUEsT0FBQSxHQUFBQyxPQUFBO0FBQ0EsSUFBQUMsSUFBQSxHQUFBRCxPQUFBO0FBQ0EsSUFBQUUsTUFBQSxHQUFBRixPQUFBO0FBQ0EsSUFBQUcsUUFBQSxHQUFBSCxPQUFBO0FBRUEsSUFBSUksZUFBZSxHQUFHLElBQUk7QUFFbkIsSUFBTUMsWUFBWSxHQUFBQyxPQUFBLENBQUFELFlBQUE7RUFBQSxJQUFBRSxJQUFBLE9BQUFDLGtCQUFBLENBQUFDLE9BQUEsRUFBRyxhQUFZO0lBQ3RDLElBQUksQ0FBQyxJQUFBQyxvQkFBVyxFQUFDLENBQUMsRUFBRTtJQUVwQixJQUFNQyxLQUFLLFNBQVMsSUFBQUMsZUFBUSxFQUFDLENBQUM7SUFDOUIsSUFBSUQsS0FBSyxDQUFDRSxNQUFNLEtBQUssQ0FBQyxFQUFFO0lBRXhCLEtBQUssSUFBTUMsSUFBSSxJQUFJSCxLQUFLLEVBQUU7TUFDeEIsSUFBSTtRQUNGLE1BQU0sSUFBQUksY0FBUyxFQUFDRCxJQUFJLENBQUM7UUFDckIsTUFBTSxJQUFBRSxzQkFBZSxFQUFDRixJQUFJLENBQUNHLEVBQUUsQ0FBQztNQUNoQyxDQUFDLENBQUMsT0FBT0MsS0FBSyxFQUFFO1FBQ2QsSUFBQUMsbUJBQVcsRUFBQ0QsS0FBSyxFQUFFO1VBQ2pCRSxLQUFLLEVBQUUsc0JBQXNCO1VBQzdCQyxFQUFFLEVBQUUsa0JBQWtCO1VBQ3RCSixFQUFFLEVBQUVILElBQUksb0JBQUpBLElBQUksQ0FBRUc7UUFDWixDQUFDLENBQUM7TUFFSjtJQUNGO0VBQ0YsQ0FBQztFQUFBLGdCQW5CWVosWUFBWUEsQ0FBQTtJQUFBLE9BQUFFLElBQUEsQ0FBQWUsS0FBQSxPQUFBQyxTQUFBO0VBQUE7QUFBQSxHQW1CeEI7QUFNTSxJQUFNQyxTQUFTLEdBQUFsQixPQUFBLENBQUFrQixTQUFBLEdBQUcsU0FBWkEsU0FBU0EsQ0FBQSxFQUFTO0VBQzdCLElBQUlwQixlQUFlLEVBQUUsT0FBT0EsZUFBZTtFQUUzQ0EsZUFBZSxHQUFHLElBQUFxQixrQkFBUyxFQUFDLFVBQUNDLFFBQVEsRUFBSztJQUN4QyxJQUFJQSxRQUFRLEVBQUU7TUFFWnJCLFlBQVksQ0FBQyxDQUFDO0lBQ2hCO0VBQ0YsQ0FBQyxDQUFDO0VBRUYsT0FBT0QsZUFBZTtBQUN4QixDQUFDO0FBRU0sSUFBTXVCLFFBQVEsR0FBQXJCLE9BQUEsQ0FBQXFCLFFBQUEsR0FBRyxTQUFYQSxRQUFRQSxDQUFBLEVBQVM7RUFDNUIsSUFBSSxDQUFDdkIsZUFBZSxFQUFFO0VBQ3RCLElBQUk7SUFDRkEsZUFBZSxDQUFDLENBQUM7RUFDbkIsQ0FBQyxTQUFTO0lBQ1JBLGVBQWUsR0FBRyxJQUFJO0VBQ3hCO0FBQ0YsQ0FBQztBQU1NLElBQU13QixxQkFBcUIsR0FBQXRCLE9BQUEsQ0FBQXNCLHFCQUFBLEdBQUcsU0FBeEJBLHFCQUFxQkEsQ0FBQSxFQUFTO0VBQ3pDRCxRQUFRLENBQUMsQ0FBQztBQUNaLENBQUM7QUFBQyxJQUFBRSxRQUFBLEdBQUF2QixPQUFBLENBQUFHLE9BQUEsR0FFYTtFQUNiSixZQUFZLEVBQVpBLFlBQVk7RUFDWm1CLFNBQVMsRUFBVEEsU0FBUztFQUNURyxRQUFRLEVBQVJBO0FBQ0YsQ0FBQyIsImlnbm9yZUxpc3QiOltdfQ==