{"version":3,"names":["_getJestObj","mock","getQueue","jest","fn","removeFromQueue","apiClient","getIsOnline","subscribe","handleError","_interopRequireDefault","require","default","_asyncToGenerator2","_errors","_api","_queue","_network","_sync","_require","describe","beforeEach","clearAllMocks","__unsafeResetForTests","mockReturnValue","mockResolvedValue","data","status","it","processQueue","expect","not","toHaveBeenCalled","queue","id","url","method","toHaveBeenCalledTimes","toHaveBeenCalledWith","mockRejectedValue","Error","mockRejectedValueOnce","mockResolvedValueOnce","unsubscribe","a","startSync","b","toBe","onChange","mockImplementation","Promise","r","setTimeout"],"sources":["sync.manager.test.js"],"sourcesContent":["/**\r\n * Sync Manager Tests\r\n * File: sync.manager.test.js\r\n */\r\nimport { handleError } from '@errors';\r\nimport { apiClient } from '@services/api';\r\nimport { getQueue, removeFromQueue } from '@offline/queue';\r\nimport { getIsOnline, subscribe } from '@offline/network.listener';\r\nimport { __unsafeResetForTests, processQueue, startSync } from '@offline/sync.manager';\r\n\r\njest.mock('@offline/queue', () => ({\r\n  getQueue: jest.fn(),\r\n  removeFromQueue: jest.fn(),\r\n}));\r\n\r\njest.mock('@services/api', () => ({\r\n  apiClient: jest.fn(),\r\n}));\r\n\r\njest.mock('@offline/network.listener', () => ({\r\n  getIsOnline: jest.fn(),\r\n  subscribe: jest.fn(),\r\n}));\r\n\r\njest.mock('@errors', () => ({\r\n  handleError: jest.fn(),\r\n}));\r\n\r\ndescribe('Sync Manager', () => {\r\n  beforeEach(() => {\r\n    jest.clearAllMocks();\r\n    __unsafeResetForTests();\r\n\r\n    getIsOnline.mockReturnValue(true);\r\n    getQueue.mockResolvedValue([]);\r\n    removeFromQueue.mockResolvedValue(true);\r\n    apiClient.mockResolvedValue({ data: {}, status: 200 });\r\n  });\r\n\r\n  describe('processQueue', () => {\r\n    it('skips processing when offline', async () => {\r\n      getIsOnline.mockReturnValue(false);\r\n\r\n      await processQueue();\r\n\r\n      expect(getQueue).not.toHaveBeenCalled();\r\n      expect(apiClient).not.toHaveBeenCalled();\r\n    });\r\n\r\n    it('returns early when queue is empty', async () => {\r\n      getQueue.mockResolvedValue([]);\r\n\r\n      await processQueue();\r\n\r\n      expect(apiClient).not.toHaveBeenCalled();\r\n    });\r\n\r\n    it('processes queue items when online', async () => {\r\n      const queue = [\r\n        { id: '1', url: '/api/test1', method: 'POST' },\r\n        { id: '2', url: '/api/test2', method: 'GET' },\r\n      ];\r\n      getQueue.mockResolvedValue(queue);\r\n\r\n      await processQueue();\r\n\r\n      expect(apiClient).toHaveBeenCalledTimes(2);\r\n      expect(apiClient).toHaveBeenCalledWith(queue[0]);\r\n      expect(apiClient).toHaveBeenCalledWith(queue[1]);\r\n    });\r\n\r\n    it('removes item from queue after successful processing', async () => {\r\n      const queue = [{ id: '1', url: '/api/test', method: 'POST' }];\r\n      getQueue.mockResolvedValue(queue);\r\n\r\n      await processQueue();\r\n\r\n      expect(removeFromQueue).toHaveBeenCalledWith('1');\r\n      expect(handleError).not.toHaveBeenCalled();\r\n    });\r\n\r\n    it('keeps item in queue on failure and reports via handleError', async () => {\r\n      const queue = [{ id: '1', url: '/api/test', method: 'POST' }];\r\n      getQueue.mockResolvedValue(queue);\r\n      apiClient.mockRejectedValue(new Error('API Error'));\r\n\r\n      await processQueue();\r\n\r\n      expect(removeFromQueue).not.toHaveBeenCalled();\r\n      expect(handleError).toHaveBeenCalled();\r\n    });\r\n\r\n    it('continues processing after item failure', async () => {\r\n      const queue = [\r\n        { id: '1', url: '/api/test1', method: 'POST' },\r\n        { id: '2', url: '/api/test2', method: 'GET' },\r\n      ];\r\n      getQueue.mockResolvedValue(queue);\r\n      apiClient.mockRejectedValueOnce(new Error('API Error')).mockResolvedValueOnce({ data: {}, status: 200 });\r\n\r\n      await processQueue();\r\n\r\n      expect(apiClient).toHaveBeenCalledTimes(2);\r\n      expect(removeFromQueue).toHaveBeenCalledTimes(1);\r\n      expect(removeFromQueue).toHaveBeenCalledWith('2');\r\n    });\r\n  });\r\n\r\n  describe('startSync', () => {\r\n    it('subscribes once and returns unsubscribe function', () => {\r\n      const unsubscribe = jest.fn();\r\n      subscribe.mockReturnValue(unsubscribe);\r\n\r\n      const a = startSync();\r\n      const b = startSync();\r\n\r\n      expect(subscribe).toHaveBeenCalledTimes(1);\r\n      expect(a).toBe(unsubscribe);\r\n      expect(b).toBe(unsubscribe);\r\n    });\r\n\r\n    it('triggers queue processing when network comes online', async () => {\r\n      let onChange;\r\n      subscribe.mockImplementation((fn) => {\r\n        onChange = fn;\r\n        return jest.fn();\r\n      });\r\n\r\n      getQueue.mockResolvedValue([{ id: '1', url: '/api/test', method: 'POST' }]);\r\n      apiClient.mockResolvedValue({ data: {}, status: 200 });\r\n\r\n      startSync();\r\n\r\n      onChange(true);\r\n      // startSync intentionally fire-and-forgets; wait a tick for async processing to complete\r\n      await new Promise((r) => setTimeout(r, 0));\r\n\r\n      expect(apiClient).toHaveBeenCalledTimes(1);\r\n      expect(removeFromQueue).toHaveBeenCalledWith('1');\r\n    });\r\n  });\r\n});\r\n\r\n"],"mappings":"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","ignoreList":[]}