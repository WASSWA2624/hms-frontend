278fe6e4967f03f6e1517ac2357bfa12
var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault").default;
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.normalizeError = exports.handleError = void 0;
var _en = _interopRequireDefault(require("../i18n/locales/en.json"));
var _logging = require("../logging");
var getNestedValue = function getNestedValue(obj, path) {
  return String(path).split('.').reduce(function (current, key) {
    return current && current[key] !== undefined ? current[key] : undefined;
  }, obj);
};
var getSafeMessageForCode = function getSafeMessageForCode(code) {
  return getNestedValue(_en.default, `errors.codes.${code}`) || getNestedValue(_en.default, 'errors.codes.UNKNOWN_ERROR') || 'UNKNOWN_ERROR';
};
var normalizeError = exports.normalizeError = function normalizeError(error) {
  var _error$message;
  if (!error) {
    var _safeMessage = getSafeMessageForCode('UNKNOWN_ERROR');
    return {
      code: 'UNKNOWN_ERROR',
      message: _safeMessage,
      safeMessage: _safeMessage,
      severity: 'error'
    };
  }
  if (error.name === 'NetworkError' || (_error$message = error.message) != null && _error$message.includes('network')) {
    var _safeMessage2 = getSafeMessageForCode('NETWORK_ERROR');
    return {
      code: 'NETWORK_ERROR',
      message: _safeMessage2,
      safeMessage: _safeMessage2,
      severity: 'warning'
    };
  }
  if (error.status || error.statusCode) {
    var status = error.status || error.statusCode;
    if (status === 401) {
      var _safeMessage3 = getSafeMessageForCode('UNAUTHORIZED');
      return {
        code: 'UNAUTHORIZED',
        message: _safeMessage3,
        safeMessage: _safeMessage3,
        severity: 'error'
      };
    }
    if (status === 403) {
      var _safeMessage4 = getSafeMessageForCode('FORBIDDEN');
      return {
        code: 'FORBIDDEN',
        message: _safeMessage4,
        safeMessage: _safeMessage4,
        severity: 'error'
      };
    }
    if (status >= 500) {
      var _safeMessage5 = getSafeMessageForCode('SERVER_ERROR');
      return {
        code: 'SERVER_ERROR',
        message: _safeMessage5,
        safeMessage: _safeMessage5,
        severity: 'error'
      };
    }
  }
  var code = error.code || 'UNKNOWN_ERROR';
  var safeMessage = getSafeMessageForCode(code);
  var rawMessage = typeof error.message === 'string' && error.message.trim() ? error.message.trim() : safeMessage;
  return {
    code: code,
    message: rawMessage,
    safeMessage: safeMessage,
    severity: error.severity || 'error'
  };
};
var handleError = exports.handleError = function handleError(error) {
  var context = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
  var normalized = normalizeError(error);
  _logging.logger.error('Handled error', {
    code: normalized.code,
    severity: normalized.severity,
    context: context && typeof context === 'object' ? context : {}
  });
  return normalized;
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfZW4iLCJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwicmVxdWlyZSIsIl9sb2dnaW5nIiwiZ2V0TmVzdGVkVmFsdWUiLCJvYmoiLCJwYXRoIiwiU3RyaW5nIiwic3BsaXQiLCJyZWR1Y2UiLCJjdXJyZW50Iiwia2V5IiwidW5kZWZpbmVkIiwiZ2V0U2FmZU1lc3NhZ2VGb3JDb2RlIiwiY29kZSIsImVuIiwibm9ybWFsaXplRXJyb3IiLCJleHBvcnRzIiwiZXJyb3IiLCJfZXJyb3IkbWVzc2FnZSIsInNhZmVNZXNzYWdlIiwibWVzc2FnZSIsInNldmVyaXR5IiwibmFtZSIsImluY2x1ZGVzIiwic3RhdHVzIiwic3RhdHVzQ29kZSIsInJhd01lc3NhZ2UiLCJ0cmltIiwiaGFuZGxlRXJyb3IiLCJjb250ZXh0IiwiYXJndW1lbnRzIiwibGVuZ3RoIiwibm9ybWFsaXplZCIsImxvZ2dlciJdLCJzb3VyY2VzIjpbImVycm9yLmhhbmRsZXIuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIEVycm9yIEhhbmRsZXJcclxuICogTm9ybWFsaXplcyBlcnJvcnMgdG8gZG9tYWluLXNhZmUgb2JqZWN0c1xyXG4gKiBGaWxlOiBlcnJvci5oYW5kbGVyLmpzXHJcbiAqL1xyXG5pbXBvcnQgZW4gZnJvbSAnQGkxOG4vbG9jYWxlcy9lbi5qc29uJztcclxuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnQGxvZ2dpbmcnO1xyXG5cclxuY29uc3QgZ2V0TmVzdGVkVmFsdWUgPSAob2JqLCBwYXRoKSA9PiB7XHJcbiAgcmV0dXJuIFN0cmluZyhwYXRoKVxyXG4gICAgLnNwbGl0KCcuJylcclxuICAgIC5yZWR1Y2UoKGN1cnJlbnQsIGtleSkgPT4gKGN1cnJlbnQgJiYgY3VycmVudFtrZXldICE9PSB1bmRlZmluZWQgPyBjdXJyZW50W2tleV0gOiB1bmRlZmluZWQpLCBvYmopO1xyXG59O1xyXG5cclxuY29uc3QgZ2V0U2FmZU1lc3NhZ2VGb3JDb2RlID0gKGNvZGUpID0+IHtcclxuICByZXR1cm4gKFxyXG4gICAgZ2V0TmVzdGVkVmFsdWUoZW4sIGBlcnJvcnMuY29kZXMuJHtjb2RlfWApIHx8XHJcbiAgICBnZXROZXN0ZWRWYWx1ZShlbiwgJ2Vycm9ycy5jb2Rlcy5VTktOT1dOX0VSUk9SJykgfHxcclxuICAgICdVTktOT1dOX0VSUk9SJ1xyXG4gICk7XHJcbn07XHJcblxyXG5jb25zdCBub3JtYWxpemVFcnJvciA9IChlcnJvcikgPT4ge1xyXG4gIGlmICghZXJyb3IpIHtcclxuICAgIGNvbnN0IHNhZmVNZXNzYWdlID0gZ2V0U2FmZU1lc3NhZ2VGb3JDb2RlKCdVTktOT1dOX0VSUk9SJyk7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBjb2RlOiAnVU5LTk9XTl9FUlJPUicsXHJcbiAgICAgIG1lc3NhZ2U6IHNhZmVNZXNzYWdlLFxyXG4gICAgICBzYWZlTWVzc2FnZSxcclxuICAgICAgc2V2ZXJpdHk6ICdlcnJvcicsXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgLy8gTmV0d29yayBlcnJvcnNcclxuICBpZiAoZXJyb3IubmFtZSA9PT0gJ05ldHdvcmtFcnJvcicgfHwgZXJyb3IubWVzc2FnZT8uaW5jbHVkZXMoJ25ldHdvcmsnKSkge1xyXG4gICAgY29uc3Qgc2FmZU1lc3NhZ2UgPSBnZXRTYWZlTWVzc2FnZUZvckNvZGUoJ05FVFdPUktfRVJST1InKTtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIGNvZGU6ICdORVRXT1JLX0VSUk9SJyxcclxuICAgICAgbWVzc2FnZTogc2FmZU1lc3NhZ2UsXHJcbiAgICAgIHNhZmVNZXNzYWdlLFxyXG4gICAgICBzZXZlcml0eTogJ3dhcm5pbmcnLFxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIC8vIEFQSSBlcnJvcnNcclxuICBpZiAoZXJyb3Iuc3RhdHVzIHx8IGVycm9yLnN0YXR1c0NvZGUpIHtcclxuICAgIGNvbnN0IHN0YXR1cyA9IGVycm9yLnN0YXR1cyB8fCBlcnJvci5zdGF0dXNDb2RlO1xyXG4gICAgaWYgKHN0YXR1cyA9PT0gNDAxKSB7XHJcbiAgICAgIGNvbnN0IHNhZmVNZXNzYWdlID0gZ2V0U2FmZU1lc3NhZ2VGb3JDb2RlKCdVTkFVVEhPUklaRUQnKTtcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICBjb2RlOiAnVU5BVVRIT1JJWkVEJyxcclxuICAgICAgICBtZXNzYWdlOiBzYWZlTWVzc2FnZSxcclxuICAgICAgICBzYWZlTWVzc2FnZSxcclxuICAgICAgICBzZXZlcml0eTogJ2Vycm9yJyxcclxuICAgICAgfTtcclxuICAgIH1cclxuICAgIGlmIChzdGF0dXMgPT09IDQwMykge1xyXG4gICAgICBjb25zdCBzYWZlTWVzc2FnZSA9IGdldFNhZmVNZXNzYWdlRm9yQ29kZSgnRk9SQklEREVOJyk7XHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgY29kZTogJ0ZPUkJJRERFTicsXHJcbiAgICAgICAgbWVzc2FnZTogc2FmZU1lc3NhZ2UsXHJcbiAgICAgICAgc2FmZU1lc3NhZ2UsXHJcbiAgICAgICAgc2V2ZXJpdHk6ICdlcnJvcicsXHJcbiAgICAgIH07XHJcbiAgICB9XHJcbiAgICBpZiAoc3RhdHVzID49IDUwMCkge1xyXG4gICAgICBjb25zdCBzYWZlTWVzc2FnZSA9IGdldFNhZmVNZXNzYWdlRm9yQ29kZSgnU0VSVkVSX0VSUk9SJyk7XHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgY29kZTogJ1NFUlZFUl9FUlJPUicsXHJcbiAgICAgICAgbWVzc2FnZTogc2FmZU1lc3NhZ2UsXHJcbiAgICAgICAgc2FmZU1lc3NhZ2UsXHJcbiAgICAgICAgc2V2ZXJpdHk6ICdlcnJvcicsXHJcbiAgICAgIH07XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBjb25zdCBjb2RlID0gZXJyb3IuY29kZSB8fCAnVU5LTk9XTl9FUlJPUic7XHJcbiAgY29uc3Qgc2FmZU1lc3NhZ2UgPSBnZXRTYWZlTWVzc2FnZUZvckNvZGUoY29kZSk7XHJcbiAgY29uc3QgcmF3TWVzc2FnZSA9XHJcbiAgICB0eXBlb2YgZXJyb3IubWVzc2FnZSA9PT0gJ3N0cmluZycgJiYgZXJyb3IubWVzc2FnZS50cmltKClcclxuICAgICAgPyBlcnJvci5tZXNzYWdlLnRyaW0oKVxyXG4gICAgICA6IHNhZmVNZXNzYWdlO1xyXG5cclxuICAvLyBEZWZhdWx0XHJcbiAgcmV0dXJuIHtcclxuICAgIGNvZGUsXHJcbiAgICBtZXNzYWdlOiByYXdNZXNzYWdlLFxyXG4gICAgc2FmZU1lc3NhZ2UsXHJcbiAgICBzZXZlcml0eTogZXJyb3Iuc2V2ZXJpdHkgfHwgJ2Vycm9yJyxcclxuICB9O1xyXG59O1xyXG5cclxuY29uc3QgaGFuZGxlRXJyb3IgPSAoZXJyb3IsIGNvbnRleHQgPSB7fSkgPT4ge1xyXG4gIGNvbnN0IG5vcm1hbGl6ZWQgPSBub3JtYWxpemVFcnJvcihlcnJvcik7XHJcbiAgbG9nZ2VyLmVycm9yKCdIYW5kbGVkIGVycm9yJywge1xyXG4gICAgY29kZTogbm9ybWFsaXplZC5jb2RlLFxyXG4gICAgc2V2ZXJpdHk6IG5vcm1hbGl6ZWQuc2V2ZXJpdHksXHJcbiAgICBjb250ZXh0OiBjb250ZXh0ICYmIHR5cGVvZiBjb250ZXh0ID09PSAnb2JqZWN0JyA/IGNvbnRleHQgOiB7fSxcclxuICB9KTtcclxuICByZXR1cm4gbm9ybWFsaXplZDtcclxufTtcclxuXHJcbmV4cG9ydCB7IG5vcm1hbGl6ZUVycm9yLCBoYW5kbGVFcnJvciB9O1xyXG5cclxuIl0sIm1hcHBpbmdzIjoiOzs7OztBQUtBLElBQUFBLEdBQUEsR0FBQUMsc0JBQUEsQ0FBQUMsT0FBQTtBQUNBLElBQUFDLFFBQUEsR0FBQUQsT0FBQTtBQUVBLElBQU1FLGNBQWMsR0FBRyxTQUFqQkEsY0FBY0EsQ0FBSUMsR0FBRyxFQUFFQyxJQUFJLEVBQUs7RUFDcEMsT0FBT0MsTUFBTSxDQUFDRCxJQUFJLENBQUMsQ0FDaEJFLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FDVkMsTUFBTSxDQUFDLFVBQUNDLE9BQU8sRUFBRUMsR0FBRztJQUFBLE9BQU1ELE9BQU8sSUFBSUEsT0FBTyxD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