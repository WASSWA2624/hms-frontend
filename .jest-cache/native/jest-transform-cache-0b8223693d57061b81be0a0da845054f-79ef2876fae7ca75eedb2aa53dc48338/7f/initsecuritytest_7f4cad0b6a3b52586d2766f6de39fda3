2c1d7306fe08a16a94ae9169f7498b81
_getJestObj().mock("../../security", function () {
  return {
    tokenManager: {
      getAccessToken: jest.fn(),
      getRefreshToken: jest.fn(),
      isTokenExpired: jest.fn()
    }
  };
});
_getJestObj().mock("../../logging", function () {
  return {
    logger: {
      info: jest.fn(),
      error: jest.fn(),
      debug: jest.fn(),
      warn: jest.fn()
    }
  };
});
var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault").default;
var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));
var _init = require("../../bootstrap/init.security");
var _security = require("../../security");
var _logging = require("../../logging");
function _getJestObj() {
  var _require = require("@jest/globals"),
    jest = _require.jest;
  _getJestObj = function _getJestObj() {
    return jest;
  };
  return jest;
}
describe('Security Initialization', function () {
  beforeEach(function () {
    jest.clearAllMocks();
  });
  it('initializes successfully when no tokens exist', (0, _asyncToGenerator2.default)(function* () {
    _security.tokenManager.getAccessToken.mockResolvedValue(null);
    _security.tokenManager.getRefreshToken.mockResolvedValue(null);
    yield (0, _init.initSecurity)();
    expect(_security.tokenManager.getAccessToken).toHaveBeenCalled();
    expect(_security.tokenManager.getRefreshToken).toHaveBeenCalled();
    expect(_logging.logger.info).toHaveBeenCalledWith('No session found on startup');
    expect(_logging.logger.info).toHaveBeenCalledWith('Security initialized successfully');
  }));
  it('initializes successfully with valid tokens', (0, _asyncToGenerator2.default)(function* () {
    _security.tokenManager.getAccessToken.mockResolvedValue('valid-token');
    _security.tokenManager.getRefreshToken.mockResolvedValue('valid-refresh-token');
    _security.tokenManager.isTokenExpired.mockReturnValue(false);
    yield (0, _init.initSecurity)();
    expect(_logging.logger.info).toHaveBeenCalledWith('Valid session found on startup');
    expect(_logging.logger.info).toHaveBeenCalledWith('Security initialized successfully');
  }));
  it('handles expired access token with refresh token available', (0, _asyncToGenerator2.default)(function* () {
    _security.tokenManager.getAccessToken.mockResolvedValue('expired-token');
    _security.tokenManager.getRefreshToken.mockResolvedValue('valid-refresh-token');
    _security.tokenManager.isTokenExpired.mockReturnValue(true);
    yield (0, _init.initSecurity)();
    expect(_logging.logger.info).toHaveBeenCalledWith('Access token expired, refresh token available');
    expect(_logging.logger.info).toHaveBeenCalledWith('Security initialized successfully');
  }));
  it('handles expired tokens without refresh token', (0, _asyncToGenerator2.default)(function* () {
    _security.tokenManager.getAccessToken.mockResolvedValue('expired-token');
    _security.tokenManager.getRefreshToken.mockResolvedValue(null);
    _security.tokenManager.isTokenExpired.mockReturnValue(true);
    yield (0, _init.initSecurity)();
    expect(_logging.logger.info).toHaveBeenCalledWith('Tokens expired, user will need to re-authenticate');
    expect(_logging.logger.info).toHaveBeenCalledWith('Security initialized successfully');
  }));
  it('handles errors gracefully without throwing', (0, _asyncToGenerator2.default)(function* () {
    var error = new Error('Security error');
    _security.tokenManager.getAccessToken.mockRejectedValue(error);
    yield expect((0, _init.initSecurity)()).resolves.not.toThrow();
    expect(_logging.logger.error).toHaveBeenCalledWith('Security initialization failed', {
      error: 'Security error'
    });
  }));
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfZ2V0SmVzdE9iaiIsIm1vY2siLCJ0b2tlbk1hbmFnZXIiLCJnZXRBY2Nlc3NUb2tlbiIsImplc3QiLCJmbiIsImdldFJlZnJlc2hUb2tlbiIsImlzVG9rZW5FeHBpcmVkIiwibG9nZ2VyIiwiaW5mbyIsImVycm9yIiwiZGVidWciLCJ3YXJuIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJkZWZhdWx0IiwiX2FzeW5jVG9HZW5lcmF0b3IyIiwiX2luaXQiLCJfc2VjdXJpdHkiLCJfbG9nZ2luZyIsIl9yZXF1aXJlIiwiZGVzY3JpYmUiLCJiZWZvcmVFYWNoIiwiY2xlYXJBbGxNb2NrcyIsIml0IiwibW9ja1Jlc29sdmVkVmFsdWUiLCJpbml0U2VjdXJpdHkiLCJleHBlY3QiLCJ0b0hhdmVCZWVuQ2FsbGVkIiwidG9IYXZlQmVlbkNhbGxlZFdpdGgiLCJtb2NrUmV0dXJuVmFsdWUiLCJFcnJvciIsIm1vY2tSZWplY3RlZFZhbHVlIiwicmVzb2x2ZXMiLCJub3QiLCJ0b1Rocm93Il0sInNvdXJjZXMiOlsiaW5pdC5zZWN1cml0eS50ZXN0LmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBTZWN1cml0eSBJbml0aWFsaXphdGlvbiBUZXN0c1xyXG4gKiBGaWxlOiBpbml0LnNlY3VyaXR5LnRlc3QuanNcclxuICovXHJcbmltcG9ydCB7IGluaXRTZWN1cml0eSB9IGZyb20gJ0Bib290c3RyYXAvaW5pdC5zZWN1cml0eSc7XHJcbmltcG9ydCB7IHRva2VuTWFuYWdlciB9IGZyb20gJ0BzZWN1cml0eSc7XHJcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJ0Bsb2dnaW5nJztcclxuXHJcbmplc3QubW9jaygnQHNlY3VyaXR5JywgKCkgPT4gKHtcclxuICB0b2tlbk1hbmFnZXI6IHtcclxuICAgIGdldEFjY2Vzc1Rva2VuOiBqZXN0LmZuKCksXHJcbiAgICBnZXRSZWZyZXNoVG9rZW46IGplc3QuZm4oKSxcclxuICAgIGlzVG9rZW5FeHBpcmVkOiBqZXN0LmZuKCksXHJcbiAgfSxcclxufSkpO1xyXG5cclxuamVzdC5tb2NrKCdAbG9nZ2luZycsICgpID0+ICh7XHJcbiAgbG9nZ2VyOiB7XHJcbiAgICBpbmZvOiBqZXN0LmZuKCksXHJcbiAgICBlcnJvcjogamVzdC5mbigpLFxyXG4gICAgZGVidWc6IGplc3QuZm4oKSxcclxuICAgIHdhcm46IGplc3QuZm4oKSxcclxuICB9LFxyXG59KSk7XHJcblxyXG5kZXNjcmliZSgnU2VjdXJpdHkgSW5pdGlhbGl6YXRpb24nLCAoKSA9PiB7XHJcbiAgYmVmb3JlRWFjaCgoKSA9PiB7XHJcbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcclxuICB9KTtcclxuXHJcbiAgaXQoJ2luaXRpYWxpemVzIHN1Y2Nlc3NmdWxseSB3aGVuIG5vIHRva2VucyBleGlzdCcsIGFzeW5jICgpID0+IHtcclxuICAgIHRva2VuTWFuYWdlci5nZXRBY2Nlc3NUb2tlbi5tb2NrUmVzb2x2ZWRWYWx1ZShudWxsKTtcclxuICAgIHRva2VuTWFuYWdlci5nZXRSZWZyZXNoVG9rZW4ubW9ja1Jlc29sdmVkVmFsdWUobnVsbCk7XHJcblxyXG4gICAgYXdhaXQgaW5pdFNlY3VyaXR5KCk7XHJcblxyXG4gICAgZXhwZWN0KHRva2VuTWFuYWdlci5nZXRBY2Nlc3NUb2tlbikudG9IYXZlQmVlbkNhbGxlZCgpO1xyXG4gICAgZXhwZWN0KHRva2VuTWFuYWdlci5nZXRSZWZyZXNoVG9rZW4pLnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICAgIGV4cGVjdChsb2dnZXIuaW5mbykudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ05vIHNlc3Npb24gZm91bmQgb24gc3RhcnR1cCcpO1xyXG4gICAgZXhwZWN0KGxvZ2dlci5pbmZvKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnU2VjdXJpdHkgaW5pdGlhbGl6ZWQgc3VjY2Vzc2Z1bGx5Jyk7XHJcbiAgfSk7XHJcblxyXG4gIGl0KCdpbml0aWFsaXplcyBzdWNjZXNzZnVsbHkgd2l0aCB2YWxpZCB0b2tlbnMnLCBhc3luYyAoKSA9PiB7XHJcbiAgICB0b2tlbk1hbmFnZXIuZ2V0QWNjZXNzVG9rZW4ubW9ja1Jlc29sdmVkVmFsdWUoJ3ZhbGlkLXRva2VuJyk7XHJcbiAgICB0b2tlbk1hbmFnZXIuZ2V0UmVmcmVzaFRva2VuLm1vY2tSZXNvbHZlZFZhbHVlKCd2YWxpZC1yZWZyZXNoLXRva2VuJyk7XHJcbiAgICB0b2tlbk1hbmFnZXIuaXNUb2tlbkV4cGlyZWQubW9ja1JldHVyblZhbHVlKGZhbHNlKTtcclxuXHJcbiAgICBhd2FpdCBpbml0U2VjdXJpdHkoKTtcclxuXHJcbiAgICBleHBlY3QobG9nZ2VyLmluZm8pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCdWYWxpZCBzZXNzaW9uIGZvdW5kIG9uIHN0YXJ0dXAnKTtcclxuICAgIGV4cGVjdChsb2dnZXIuaW5mbykudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ1NlY3VyaXR5IGluaXRpYWxpemVkIHN1Y2Nlc3NmdWxseScpO1xyXG4gIH0pO1xyXG5cclxuICBpdCgnaGFuZGxlcyBleHBpcmVkIGFjY2VzcyB0b2tlbiB3aXRoIHJlZnJlc2ggdG9rZW4gYXZhaWxhYmxlJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgdG9rZW5NYW5hZ2VyLmdldEFjY2Vzc1Rva2VuLm1vY2tSZXNvbHZlZFZhbHVlKCdleHBpcmVkLXRva2VuJyk7XHJcbiAgICB0b2tlbk1hbmFnZXIuZ2V0UmVmcmVzaFRva2VuLm1vY2tSZXNvbHZlZFZhbHVlKCd2YWxpZC1yZWZyZXNoLXRva2VuJyk7XHJcbiAgICB0b2tlbk1hbmFnZXIuaXNUb2tlbkV4cGlyZWQubW9ja1JldHVyblZhbHVlKHRydWUpO1xyXG5cclxuICAgIGF3YWl0IGluaXRTZWN1cml0eSgpO1xyXG5cclxuICAgIGV4cGVjdChsb2dnZXIuaW5mbykudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ0FjY2VzcyB0b2tlbiBleHBpcmVkLCByZWZyZXNoIHRva2VuIGF2YWlsYWJsZScpO1xyXG4gICAgZXhwZWN0KGxvZ2dlci5pbmZvKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnU2VjdXJpdHkgaW5pdGlhbGl6ZWQgc3VjY2Vzc2Z1bGx5Jyk7XHJcbiAgfSk7XHJcblxyXG4gIGl0KCdoYW5kbGVzIGV4cGlyZWQgdG9rZW5zIHdpdGhvdXQgcmVmcmVzaCB0b2tlbicsIGFzeW5jICgpID0+IHtcclxuICAgIHRva2VuTWFuYWdlci5nZXRBY2Nlc3NUb2tlbi5tb2NrUmVzb2x2ZWRWYWx1ZSgnZXhwaXJlZC10b2tlbicpO1xyXG4gICAgdG9rZW5NYW5hZ2VyLmdldFJlZnJlc2hUb2tlbi5tb2NrUmVzb2x2ZWRWYWx1ZShudWxsKTtcclxuICAgIHRva2VuTWFuYWdlci5pc1Rva2VuRXhwaXJlZC5tb2NrUmV0dXJuVmFsdWUodHJ1ZSk7XHJcblxyXG4gICAgYXdhaXQgaW5pdFNlY3VyaXR5KCk7XHJcblxyXG4gICAgZXhwZWN0KGxvZ2dlci5pbmZvKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnVG9rZW5zIGV4cGlyZWQsIHVzZXIgd2lsbCBuZWVkIHRvIHJlLWF1dGhlbnRpY2F0ZScpO1xyXG4gICAgZXhwZWN0KGxvZ2dlci5pbmZvKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnU2VjdXJpdHkgaW5pdGlhbGl6ZWQgc3VjY2Vzc2Z1bGx5Jyk7XHJcbiAgfSk7XHJcblxyXG4gIGl0KCdoYW5kbGVzIGVycm9ycyBncmFjZWZ1bGx5IHdpdGhvdXQgdGhyb3dpbmcnLCBhc3luYyAoKSA9PiB7XHJcbiAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcignU2VjdXJpdHkgZXJyb3InKTtcclxuICAgIHRva2VuTWFuYWdlci5nZXRBY2Nlc3NUb2tlbi5tb2NrUmVqZWN0ZWRWYWx1ZShlcnJvcik7XHJcblxyXG4gICAgYXdhaXQgZXhwZWN0KGluaXRTZWN1cml0eSgpKS5yZXNvbHZlcy5ub3QudG9UaHJvdygpO1xyXG5cclxuICAgIGV4cGVjdChsb2dnZXIuZXJyb3IpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCdTZWN1cml0eSBpbml0aWFsaXphdGlvbiBmYWlsZWQnLCB7XHJcbiAgICAgIGVycm9yOiAnU2VjdXJpdHkgZXJyb3InLFxyXG4gICAgfSk7XHJcbiAgfSk7XHJcbn0pO1xyXG5cclxuIl0sIm1hcHBpbmdzIjoiQUFRQUEsV0FBQSxHQUFLQyxJQUFJLG1CQUFjO0VBQUEsT0FBTztJQUM1QkMsWUFBWSxFQUFFO01BQ1pDLGNBQWMsRUFBRUMsSUFBSSxDQUFDQyxFQUFFLENBQUMsQ0FBQztNQUN6QkMsZUFBZSxFQUFFRixJQUFJLENBQUNDLEVBQUUsQ0FBQyxDQUFDO01BQzFCRSxjQUFjLEVBQUVILElBQUksQ0FBQ0MsRUFBRSxDQUFDO0lBQzFCO0VBQ0YsQ0FBQztBQUFBLENBQUMsQ0FBQztBQUVITCxXQUFBLEdBQUtDLElBQUksa0JBQWE7RUFBQSxPQUFPO0lBQzNCTyxNQUFNLEVBQUU7TUFDTkMsSUFBSSxFQUFFTCxJQUFJLENBQUNDLEVBQUUsQ0FBQyxDQUFDO01BQ2ZLLEtBQUssRUFBRU4sSUFBSSxDQUFDQyxFQUFFLENBQUMsQ0FBQztNQUNoQk0sS0FBSyxFQUFFUCxJQUFJLENBQUNDLEVBQUUsQ0FBQyxDQUFDO01BQ2hCTyxJQUFJLEVBQUVSLElBQUksQ0FBQ0MsRUFBRSxDQUFDO0lBQ2hCO0VBQ0YsQ0FBQztBQUFBLENBQUMsQ0FBQztBQUFDLElBQUFRLHNCQUFBLEdBQUFDLE9BQUEsaURBQUFDLE9BQUE7QUFBQSxJQUFBQyxrQkFBQSxHQUFBSCxzQkFBQSxDQUFBQyxPQUFBO0FBbkJKLElBQUFHLEtBQUEsR0FBQUgsT0FBQTtBQUNBLElBQUFJLFNBQUEsR0FBQUosT0FBQTtBQUNBLElBQUFLLFFBQUEsR0FBQUwsT0FBQTtBQUFrQyxTQUFBZCxZQUFBO0VBQUEsSUFBQW9CLFFBQUEsR0FBQU4sT0FBQTtJQUFBVixJQUFBLEdBQUFnQixRQUFBLENBQUFoQixJQUFBO0VBQUFKLFdBQUEsWUFBQUEsWUFBQTtJQUFBLE9BQUFJLElBQUE7RUFBQTtFQUFBLE9BQUFBLElBQUE7QUFBQTtBQW1CbENpQixRQUFRLENBQUMseUJBQXlCLEVBQUUsWUFBTTtFQUN4Q0MsVUFB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